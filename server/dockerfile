# 1Ô∏è‚É£ Imatge base oficial de Node.js
FROM node:18-alpine AS builder

# 2Ô∏è‚É£ Definir el directori de treball
WORKDIR /app

# 3Ô∏è‚É£ Copiar nom√©s els fitxers de depend√®ncies per optimitzar la cach√©
COPY package*.json tsconfig.json ./

# 4Ô∏è‚É£ Instal¬∑lar depend√®ncies
RUN npm install

# 5Ô∏è‚É£ Copiar el codi font
COPY ./src ./src

# 6Ô∏è‚É£ Compilar el codi TypeScript
RUN npm run build
ENV PATH=/usr/local/bin:$PATH
EXPOSE 3000 3443

# üîü Comanda d'inici
CMD ["node", "/app/src/app.js"]

# -- Estadi final (Nom√©s per executar l'app) --
FROM node:18-alpine AS runner

WORKDIR /app

# Ensure node is available in the PATH
ENV PATH=/usr/local/bin:$PATH

# 7Ô∏è‚É£ Copiar nom√©s el codi compilat i les depend√®ncies de producci√≥
COPY package*.json ./
RUN npm install --only=production
COPY --from=builder /app/dist/src ./src
# Ensure the entry point file exists
RUN ls -l ./src/app.js || (echo "Entry point file not found!" && exit 1)
#COPY ./cert ./cert

# 8Ô∏è‚É£ Definir variables d'entorn
ENV ENTORN=production
ENV MONGODB_URI=mongodb://mongo:27017/mydb
ENV MONGODB_DB=menudb
ENV SERVER_PORT=3000
ENV SERVER_KEY=./cert/server.key
ENV SERVER_CERT=./cert/server.cert

# 9Ô∏è‚É£ Exposar el port
EXPOSE 3000 3443

# üîü Comanda d'inici
CMD ["node", "/app/src/app.js"]

